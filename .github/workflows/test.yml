
name: ORI Garden ‚Äî Sandbox & Safety Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  sandbox-tests:
    name: Sandbox Integrity & Dignity Gate
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Setup Node.js environment
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # -----------------------------
      # Install dependencies (if any)
      # -----------------------------
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found ‚Äî running in minimal mode"
          fi

      # -----------------------------
      # Run JavaScript sandbox tests
      # -----------------------------
      - name: Run sandbox JS tests
        run: |
          echo "Running sandbox JS tests..."
          node -e "
          const fs = require('fs');
          const path = require('path');

          const testDir = 'sandbox/tests';
          const files = fs.readdirSync(testDir).filter(f => f.endsWith('.test.js'));

          if (files.length === 0) {
            console.error('‚ùå No .test.js files found');
            process.exit(1);
          }

          for (const file of files) {
            console.log('‚ñ∂ Running', file);
            require(path.resolve(testDir, file));
          }

          console.log('‚úÖ All JS sandbox tests passed');
          "

      # -----------------------------
      # Validate Markdown test specs (structure)
      # -----------------------------
      - name: Validate sandbox Markdown test specs
        run: |
          echo "Validating sandbox .test.md files..."
          files=$(ls sandbox/tests/*.test.md 2>/dev/null || true)

          if [ -z "$files" ]; then
            echo "‚ùå No .test.md files found"
            exit 1
          fi

          for file in $files; do
            echo "‚ñ∂ Checking $file"
            grep -q "## Scenario" "$file" || (echo "‚ùå Missing '## Scenario' in $file" && exit 1)
            grep -q "## Expected Behavior" "$file" || (echo "‚ùå Missing '## Expected Behavior' in $file" && exit 1)
            grep -q "## Safety Invariants" "$file" || (echo "‚ùå Missing '## Safety Invariants' in $file" && exit 1)
          done

          echo "‚úÖ All Markdown sandbox tests structurally valid"

      # -----------------------------
      # Enforce canonical adversarial sandbox tests (MD)
      # -----------------------------
      - name: Verify canonical adversarial sandbox tests
        run: |
          echo "üîç Verifying canonical adversarial sandbox tests..."

          REQUIRED_FILES=(
            sandbox/tests/README.md
            sandbox/tests/adversarial_apology_reentry.test.md
            sandbox/tests/time_based_trust_attack.test.md
            sandbox/tests/false_reform_pattern.test.md
            sandbox/tests/progressive_compliance_trap.test.md
            sandbox/tests/invariants_behavior_matrix.test.md
            sandbox/tests/safety_behavior.test.md
          )

          MISSING=0

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required adversarial test: $file"
              MISSING=1
            else
              echo "‚úÖ Found $file"
            fi
          done

          if [ "$MISSING" -ne 0 ]; then
            echo ""
            echo "üö® Sandbox adversarial test suite is incomplete."
            echo "CI blocked: ethical invariants must be preserved."
            exit 1
          fi

          echo "üõ°Ô∏è All canonical adversarial sandbox tests are present."

      # -----------------------------
      # Sandbox exit must never be bypassed
      # -----------------------------
      - name: Enforce sandbox exit discipline
        run: |
          echo "Ensuring no bypass logic exists..."
          if grep -R "forceExitSandbox" -n .; then
            echo "‚ùå Forbidden sandbox bypass detected"
            exit 1
          fi
          echo "‚úÖ No sandbox bypass found"

      # -----------------------------
      # Final integrity signal
      # -----------------------------
      - name: Sandbox integrity confirmed
        run: |
          echo "ü¶å ORI Garden sandbox integrity verified"
          echo "‚úî Dignity-first"
          echo "‚úî No coercive shortcut"
          echo "‚úî Exit is earned, not assumed"
