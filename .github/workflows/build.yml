
name: ORI Garden â€” Build & Structure Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¬ Checkout repository
        uses: actions/checkout@v4

      # ---------- Environment ----------
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ---------- JS sanity ----------
      - name: ğŸ“¦ Install Node dependencies (if any)
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found â€” JS build skipped"
          fi

      - name: ğŸ” Validate JS examples load
        run: |
          echo "Checking JS example files"
          node -e "
            require('./examples/js/load_persona.js');
            require('./examples/js/persona_switching.js');
            require('./examples/js/invariants_enforcement.js');
            console.log('JS examples loaded successfully');
          "

      # ---------- Python sanity ----------
      - name: ğŸ§ª Validate Python tools import
        run: |
          echo "Checking Python tools imports"
          python - <<EOF
          import tools.schema_validator
          import tools.dignity_metric_checker
          import tools.persona_diff
          print('Python tools imported successfully')
          EOF

      # ---------- Folder integrity ----------
      - name: ğŸ—‚ï¸ Verify required folders exist
        run: |
          REQUIRED_DIRS=(
            "docs"
            "examples"
            "tools"
            "sandbox"
            ".github/workflows"
          )

          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ Missing required directory: $dir"
              exit 1
            fi
          done

          echo "All required directories present"

      # ---------- Protocol metadata ----------
      - name: ğŸ›¡ï¸ Validate protocol headers
        run: |
          echo "Scanning for ORI-GARDEN protocol headers"
          grep -R "protocol: \"ORI-GARDEN\"" docs/ sandbox/ || \
          echo "âš ï¸ Some files may not include protocol headers"

      # ---------- Build summary ----------
      - name: ğŸ“¦ Build summary
        run: |
          echo "ORI Garden build completed"
          echo "â€¢ Structure validated"
          echo "â€¢ Examples loadable"
          echo "â€¢ Tools importable"
          echo "â€¢ Protocol intact"
